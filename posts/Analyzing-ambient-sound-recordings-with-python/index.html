<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title> science</title><meta name="description" content="This is a short tutorial on how I process and analyze passive acoustic data from autonomous underwater recorders that are moored in the ocean for up to sever..."><link rel="canonical" href="/posts/Analyzing-ambient-sound-recordings-with-python/"><link rel="alternate" type="application/rss+xml" title="Sebastian Menze" href="/feed.xml"><link href='https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|Roboto+Condensed:700&subset=latin' rel='stylesheet' type='text/css'><link rel="stylesheet" href="/assets/css/main.css"><meta property="og:url" content="/posts/Analyzing-ambient-sound-recordings-with-python/"><meta property="og:type" content="website"><meta property="og:title" content="Analyzing ambient sound recordings from Aural M2 recorders with python"><meta property="og:description" content=""><meta property="og:site_name" content="Sebastian Menze"><meta name="twitter:card" content="summary"><meta name="twitter:url" content="/posts/Analyzing-ambient-sound-recordings-with-python/"><meta name="twitter:title" content="Analyzing ambient sound recordings from Aural M2 recorders with python"><meta name="twitter:description" content=""><meta property="og:image" content="/assets/images/aural/longterm_spectrogram_2017.jpg"><meta name="twitter:image" content="/assets/images/aural/longterm_spectrogram_2017.jpg"><body><div id="shadow"></div><header class="main-header content-wrapper"> <input type="checkbox" id="menu-checkbox" /><nav class="center-wrapper nav-main"> <a class="blog-logo" href="/">Sebastian Menze</a> <a href="/about/">About</a> <a href="/posts/">Blog</a> <a href="/publications/">Publications</a> <a href="/feed.xml">RSS</a> <label for="menu-checkbox" class="toggle-button" data-open="☰" data-close="☰" onclick></label></nav></header><aside class="sidebar" role="note" style="background-image: url(/assets/images/aural/longterm_spectrogram_2017.jpg)"><div class="cover"><div class="cover-text"><div class="heading"> <a href="/posts/#science">science</a></div><p></div></div><div id="switcher"></div></aside><main class="content-wrapper blog-content"><article class="post"><h1 class="post-title">Analyzing ambient sound recordings from Aural M2 recorders with python</h1><p class="post-meta"> <time datetime="2021-03-02">02-03-2021</time> &nbsp;/&nbsp; <span>Sebastian</span><div class="post-content"><p>This is a short tutorial on how I process and analyze passive acoustic data from autonomous underwater recorders that are moored in the ocean for up to several years. I am interested in analyzing how the ambient sound varies with time and location, and how loud the “choruses” of different marine mammal of vocalizations are over time. To achieve this I am simply simply calculating the power spectral density (PSD) over a 5 minute time period, so that I get one spectrum per recording. But lets start at the beginning.<h2 id="splitting-the-wav-files">Splitting the .wav files</h2><p>Once you have recovered the Aural M2 recorder, you need to download the data onto your local drive and split the .wav files into the correct lengths (as they are bunched together in large files by the recorder software). Here I am using python 3 and import these modules:<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">scipy.io.wavfile</span> <span class="k">as</span> <span class="n">wav</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="nn">datetime</span> <span class="k">as</span> <span class="n">dt</span>
</code></pre></div></div><p>I am using this code and the Aural M-2 software InfoWav to split the files so that each .wav file contains only recordings from the their respective 8-min snippet:<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">metadata</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">r</span><span class="s">"C:\Users\admin\Documents\passive_acoustics\MASTER\Bilan_D7BA_20201125151336.txt"</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s">';'</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">targetfolder</span><span class="o">=</span><span class="sa">r</span><span class="s">"C:\Users\a5278\Documents\passive_acoustics\aural_wav_files\\"</span>

<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">.</span><span class="n">glob</span><span class="p">(</span><span class="sa">r</span><span class="s">"C:\Users\admin\Documents\passive_acoustics\aural_raw_wav\*.wav"</span><span class="p">):</span> 
    <span class="k">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> 
    <span class="n">fs</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">wav</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    
    <span class="n">recordlength</span><span class="o">=</span><span class="n">fs</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">8</span>
    <span class="n">ix_segment</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">recordlength</span>
    
    <span class="n">ix_metadata</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">where</span><span class="p">(</span> <span class="n">metadata</span><span class="p">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span><span class="n">name</span> <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1">#ix_mark=np.where( x==-16192 )[0]
</span>    
    <span class="n">ix_start</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">ix</span> <span class="ow">in</span> <span class="n">ix_metadata</span><span class="p">:</span>
        <span class="n">datestr</span><span class="o">=</span><span class="n">metadata</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span><span class="mi">9</span><span class="p">]</span><span class="o">+</span><span class="s">'_'</span><span class="o">+</span><span class="n">metadata</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ix</span><span class="p">,</span><span class="mi">10</span><span class="p">]</span>
        <span class="n">datestr</span><span class="o">=</span><span class="n">datestr</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span><span class="s">'_'</span><span class="p">)</span>
        <span class="n">datestr</span><span class="o">=</span><span class="n">datestr</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">':'</span><span class="p">,</span><span class="s">'_'</span><span class="p">)</span>
        
        <span class="k">print</span><span class="p">(</span><span class="s">'aural_'</span><span class="o">+</span><span class="n">datestr</span><span class="p">)</span>
        <span class="n">x_file</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="n">ix_segment</span><span class="p">[</span><span class="n">ix_start</span><span class="p">]</span><span class="o">+</span><span class="mi">10</span><span class="p">:</span><span class="n">ix_segment</span><span class="p">[</span><span class="n">ix_start</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">10</span><span class="p">]</span>       
        <span class="n">wav</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">targetfolder</span><span class="o">+</span><span class="s">'aural_'</span><span class="o">+</span><span class="n">datestr</span><span class="o">+</span><span class="s">'.wav'</span><span class="p">,</span><span class="n">fs</span><span class="p">,</span><span class="n">x_file</span><span class="p">)</span>  
        <span class="n">ix_start</span><span class="o">=</span><span class="n">ix_start</span><span class="o">+</span><span class="mi">1</span>
</code></pre></div></div><p>To check if anything weired happened to the mooring, I am looking at the temperature and depth logged by the aural. The mooring did move, but no single dive event stands out:<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>      
<span class="n">plt</span><span class="p">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">211</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span> <span class="n">pd</span><span class="p">.</span><span class="n">to_numeric</span><span class="p">(</span> <span class="n">metadata</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">50</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">].</span><span class="nb">str</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">','</span><span class="p">,</span><span class="s">'.'</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Temperature in deg C'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">212</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">pd</span><span class="p">.</span><span class="n">to_numeric</span><span class="p">(</span> <span class="n">metadata</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">50</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">].</span><span class="nb">str</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">','</span><span class="p">,</span><span class="s">'.'</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Depth in m'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">gca</span><span class="p">().</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>
</code></pre></div></div><p><img src="/assets/images/aural/metadata.jpg" alt="" /><h2 id="spectrograms-for-each-wav-file">Spectrograms for each .wav file</h2><p>With this script you can generate spectrograms for each .wav file in a folder, for visual analysis of marine mammal calls or the like:<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">wavfolder</span><span class="o">=</span><span class="sa">r</span><span class="s">'I:\postdoc_krill\pam\2017_aural'</span>

<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">.</span><span class="n">glob</span><span class="p">(</span><span class="n">wavfolder</span><span class="o">+</span><span class="s">'\*.wav'</span><span class="p">,</span><span class="n">recursive</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span> 
    <span class="k">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> 
    <span class="n">fs</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">wav</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    
    <span class="n">db_saturation</span><span class="o">=</span><span class="mi">155</span>
    <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">/</span><span class="mi">32767</span> 
    <span class="n">p</span> <span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,(</span><span class="n">db_saturation</span><span class="o">/</span><span class="mi">20</span><span class="p">))</span><span class="o">*</span><span class="n">x</span> <span class="c1">#convert data.signal to uPa    
</span>    
    <span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">Sxx</span> <span class="o">=</span> <span class="n">signal</span><span class="p">.</span><span class="n">spectrogram</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="s">'hamming'</span><span class="p">,</span><span class="n">nperseg</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">13</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>      
    <span class="n">fig</span><span class="p">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">clf</span><span class="p">()</span>
    
    <span class="n">plt</span><span class="p">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">log10</span><span class="p">(</span><span class="n">Sxx</span><span class="p">)</span> <span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s">'plasma'</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Frequency [Hz]'</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s">'Time [sec]'</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">yscale</span><span class="p">(</span><span class="s">'symlog'</span><span class="p">)</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span><span class="n">f</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">clim</span><span class="p">([</span><span class="mi">40</span><span class="p">,</span><span class="mi">100</span><span class="p">])</span>
    <span class="n">plt</span><span class="p">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="c1">#plt.show()
</span>    
    <span class="n">plt</span><span class="p">.</span><span class="n">savefig</span><span class="p">(</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s">'.jpg'</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">200</span> <span class="p">)</span>
</code></pre></div></div><p>This will produce a spectrogram like this for each wav file:<p><img src="/assets/images/aural/minke.jpg" alt="minke" /><h2 id="long-term-spectrogram-and-marine-mammal-chorus-levels">Long term spectrogram and marine mammal chorus levels</h2><p>Instead of calculating the spectrogram for each wav file, we can also calculate the average PSD (spectrum) for each file. This is a simple and efficient way to study the ambient sound. As you can see from the spectrogram above most the the recording is ambient sound. So if we just average over the entire recordings we get a good measure of how much sound energy is in each frequency band.<p>For each spectrum (wav file), we can also pick out how much energy is in some of the characteristic peaks. In my case there are two defined peaks in the spectra: the blue whale chorus at around 27 HZ and the fin whale chorus around between 80 and 90 Hz. To calculate the sound levels of these choruses i subtract interpolated ambient sound pressure from the measured sound presser in the chorus frequency band.<p>The entire script to calculate the spectra and chorus levels then looks like this:<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">flog</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">logspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>

<span class="n">meta</span><span class="o">=</span><span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s">'filenames'</span><span class="p">,</span><span class="s">'time'</span><span class="p">,</span><span class="s">'chorus_bw'</span><span class="p">,</span><span class="s">'chorus_bw_snr'</span><span class="p">,</span><span class="s">'chorus_fin'</span><span class="p">,</span><span class="s">'chorus_fin_snr'</span><span class="p">])</span>
<span class="n">meta</span><span class="p">[</span><span class="s">'filenames'</span><span class="p">]</span><span class="o">=</span><span class="n">glob</span><span class="p">.</span><span class="n">glob</span><span class="p">(</span><span class="n">wavfolder</span><span class="o">+</span><span class="s">'\*.wav'</span><span class="p">)</span>

<span class="n">lt_spec</span><span class="o">=</span><span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="n">np</span><span class="p">.</span><span class="n">ones</span><span class="p">(</span> <span class="p">[</span> <span class="n">meta</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">flog</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">]</span> <span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">nan</span> <span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">row</span> <span class="ow">in</span> <span class="n">meta</span><span class="p">.</span><span class="n">iterrows</span><span class="p">():</span>    
    <span class="k">try</span><span class="p">:</span>          
        <span class="n">name</span><span class="o">=</span><span class="n">meta</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> 
        
        <span class="n">t</span><span class="o">=</span> <span class="n">dt</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">strptime</span><span class="p">(</span> <span class="n">name</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\\</span><span class="s">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'.'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="p">,</span> <span class="s">'aural_%Y_%m_%d_%H_%M_%S'</span> <span class="p">)</span> 
        <span class="n">meta</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">t</span>
        
        <span class="n">fs</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">wav</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>  
        <span class="n">db_saturation</span><span class="o">=</span><span class="mi">155</span>
        <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">/</span><span class="mi">32767</span> 
        <span class="n">p</span> <span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,(</span><span class="n">db_saturation</span><span class="o">/</span><span class="mi">20</span><span class="p">))</span><span class="o">*</span><span class="n">x</span> <span class="c1">#convert data.signal to uPa    
</span>        <span class="n">f</span><span class="p">,</span> <span class="n">Pxx</span> <span class="o">=</span> <span class="n">signal</span><span class="p">.</span><span class="n">welch</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="s">'hamming'</span><span class="p">,</span><span class="n">nperseg</span><span class="o">=</span><span class="mi">2</span><span class="o">**</span><span class="mi">16</span><span class="p">)</span>
        <span class="n">specint</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">interp</span><span class="p">(</span><span class="n">flog</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">Pxx</span><span class="p">)</span>
        
        <span class="c1"># fig=plt.figure(num=1)      
</span>        <span class="c1"># plt.clf()
</span>        <span class="c1"># plt.plot(f,10*np.log10(Pxx) ,'-k')
</span>        <span class="c1"># plt.plot(flog,10*np.log10(specint) ,'.r')
</span>        <span class="c1"># plt.xscale('log')
</span>        <span class="c1"># plt.xlim([10,f[-1]])
</span>        <span class="c1"># plt.ylim([40,105])
</span>        
        <span class="c1">######### blue whale chorus
</span>        <span class="n">ix_f</span><span class="o">=</span><span class="p">(</span><span class="n">flog</span><span class="o">&gt;</span><span class="mi">23</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span> <span class="n">flog</span><span class="o">&lt;</span><span class="mi">31</span><span class="p">)</span> 
        <span class="n">ix_fit</span><span class="o">=</span> <span class="p">(</span><span class="n">flog</span><span class="o">&gt;</span><span class="mi">23</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">flog</span><span class="o">&lt;</span><span class="mf">24.4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span> <span class="n">flog</span><span class="o">&gt;</span><span class="mf">26.7</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span> <span class="n">flog</span><span class="o">&lt;</span><span class="mi">31</span><span class="p">)</span>
        <span class="n">ix_chorus</span><span class="o">=</span> <span class="p">(</span><span class="n">flog</span><span class="o">&gt;</span><span class="mf">24.4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="n">flog</span><span class="o">&lt;</span><span class="mf">26.7</span><span class="p">)</span>
         
        <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="n">flog</span><span class="p">[</span><span class="n">ix_fit</span><span class="p">])</span>
        <span class="n">y</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">log10</span><span class="p">(</span><span class="n">specint</span><span class="p">[</span><span class="n">ix_fit</span><span class="p">])</span>
        <span class="n">xf</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="n">flog</span><span class="p">[</span><span class="n">ix_f</span><span class="p">])</span>
        <span class="n">xchorus</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="n">flog</span><span class="p">[</span><span class="n">ix_chorus</span><span class="p">])</span>
        <span class="n">pf</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">poly1d</span><span class="p">(</span> <span class="n">np</span><span class="p">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="mi">1</span> <span class="p">)</span> <span class="p">)</span>  
        
        <span class="n">p_chorus</span><span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span> <span class="n">specint</span><span class="p">[</span><span class="n">ix_chorus</span><span class="p">])</span>      
        <span class="n">p_ambient</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span> <span class="n">np</span><span class="p">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">pf</span><span class="p">(</span> <span class="n">xchorus</span> <span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span> <span class="p">)</span> 
        <span class="n">chorus_level_bw</span><span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">log10</span><span class="p">(</span> <span class="n">p_chorus</span><span class="o">-</span><span class="n">p_ambient</span> <span class="p">)</span>
        
        <span class="n">meta</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">chorus_level_bw</span>
        <span class="n">meta</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">log10</span><span class="p">(</span> <span class="n">p_chorus</span><span class="o">/</span><span class="n">p_ambient</span> <span class="p">)</span>
        
        <span class="c1">######### fin chorus
</span>        <span class="n">ix_f</span><span class="o">=</span><span class="p">(</span><span class="n">flog</span><span class="o">&gt;</span><span class="mi">70</span><span class="p">)</span> <span class="o">&amp;</span><span class="p">(</span> <span class="n">flog</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">)</span> 
        <span class="n">ix_fit</span><span class="o">=</span> <span class="p">(</span><span class="n">flog</span><span class="o">&gt;</span><span class="mi">75</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">flog</span><span class="o">&lt;</span><span class="mi">82</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span> <span class="n">flog</span><span class="o">&gt;</span><span class="mi">90</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span> <span class="n">flog</span><span class="o">&lt;</span><span class="mi">98</span><span class="p">)</span>
        <span class="n">ix_chorus</span><span class="o">=</span> <span class="p">(</span><span class="n">flog</span><span class="o">&gt;</span><span class="mi">82</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span> <span class="n">flog</span><span class="o">&lt;</span><span class="mi">90</span><span class="p">)</span>
         
        <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="n">flog</span><span class="p">[</span><span class="n">ix_fit</span><span class="p">])</span>
        <span class="n">y</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">log10</span><span class="p">(</span><span class="n">specint</span><span class="p">[</span><span class="n">ix_fit</span><span class="p">])</span>
        <span class="n">xf</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="n">flog</span><span class="p">[</span><span class="n">ix_f</span><span class="p">])</span>
        <span class="n">xchorus</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="n">flog</span><span class="p">[</span><span class="n">ix_chorus</span><span class="p">])</span>
        <span class="n">pf</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">poly1d</span><span class="p">(</span> <span class="n">np</span><span class="p">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="mi">1</span> <span class="p">)</span> <span class="p">)</span>  
        
        <span class="n">p_chorus</span><span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span> <span class="n">specint</span><span class="p">[</span><span class="n">ix_chorus</span><span class="p">])</span>      
        <span class="n">p_ambient</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nb">sum</span><span class="p">(</span> <span class="n">np</span><span class="p">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="n">pf</span><span class="p">(</span> <span class="n">xchorus</span> <span class="p">)</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span> <span class="p">)</span> 
        <span class="n">chorus_level_fin</span><span class="o">=</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">log10</span><span class="p">(</span> <span class="n">p_chorus</span><span class="o">-</span><span class="n">p_ambient</span> <span class="p">)</span>    
        
        <span class="n">meta</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span><span class="o">=</span><span class="n">chorus_level_fin</span>
        <span class="n">meta</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span><span class="o">=</span><span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">log10</span><span class="p">(</span> <span class="n">p_chorus</span><span class="o">/</span><span class="n">p_ambient</span> <span class="p">)</span>
        
        <span class="n">lt_spec</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">=</span><span class="n">specint</span>
    <span class="k">except</span><span class="p">:</span> 
        <span class="k">print</span><span class="p">(</span><span class="s">'error'</span><span class="p">)</span>
</code></pre></div></div><p>After this is complete we can plot the chorus and ambient sound levels:<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>      
<span class="n">plt</span><span class="p">.</span><span class="n">clf</span><span class="p">()</span>

<span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">311</span><span class="p">)</span>
<span class="n">ix_valid</span><span class="o">=</span><span class="n">meta</span><span class="p">[</span><span class="s">'chorus_bw_snr'</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">3</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s">'time'</span><span class="p">][</span><span class="n">ix_valid</span><span class="p">],</span><span class="n">meta</span><span class="p">[</span><span class="s">'chorus_bw'</span><span class="p">][</span><span class="n">ix_valid</span><span class="p">],</span><span class="s">'.b'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'PSD in dB re 1 $\mu$Pa'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Blue whale chorus'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">grid</span><span class="p">()</span>

<span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">312</span><span class="p">)</span>
<span class="n">ix_valid</span><span class="o">=</span><span class="n">meta</span><span class="p">[</span><span class="s">'chorus_fin_snr'</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">3</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s">'time'</span><span class="p">][</span><span class="n">ix_valid</span><span class="p">],</span><span class="n">meta</span><span class="p">[</span><span class="s">'chorus_fin'</span><span class="p">][</span><span class="n">ix_valid</span><span class="p">],</span><span class="s">'.r'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'PSD in dB re 1 $\mu$Pa'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Fin whale chorus'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">grid</span><span class="p">()</span>

<span class="n">ix</span><span class="o">=</span><span class="p">(</span><span class="n">flog</span><span class="o">&gt;</span><span class="mi">30</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">flog</span><span class="o">&lt;</span><span class="mi">80</span><span class="p">)</span>
<span class="n">psd_ambient</span><span class="o">=</span>  <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">log10</span><span class="p">(</span>  <span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span> <span class="n">lt_spec</span><span class="p">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">ix</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>  <span class="p">)</span> 
<span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">313</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s">'time'</span><span class="p">],</span><span class="n">psd_ambient</span><span class="p">,</span><span class="s">'-k'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'PSD in dB re 1 $\mu$Pa'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Ambient sound 30-80 Hz'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">grid</span><span class="p">()</span>

<span class="n">plt</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="c1"># plt.savefig( 'choruses_and_ambient_2017.jpg',dpi=300 )
</span></code></pre></div></div><p><img src="/assets/images/aural/choruses_and_ambient_2017.jpg" alt="choruses_and_ambient_2017" /><p>To plot the long term spectrogram we can use the function pcolormesh:<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="o">=</span><span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>      
<span class="n">fig</span><span class="p">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="s">'time'</span><span class="p">],</span><span class="n">flog</span><span class="p">,</span><span class="n">np</span><span class="p">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">rot90</span><span class="p">(</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="p">.</span><span class="n">log10</span><span class="p">(</span><span class="n">lt_spec</span><span class="p">)</span> <span class="p">)),</span><span class="n">cmap</span><span class="o">=</span><span class="s">'plasma'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">yscale</span><span class="p">(</span><span class="s">'log'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span><span class="mf">1e4</span><span class="p">])</span>
<span class="n">plt</span><span class="p">.</span><span class="n">clim</span><span class="p">([</span><span class="mi">40</span><span class="p">,</span><span class="mi">110</span><span class="p">])</span>
<span class="n">plt</span><span class="p">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'PSD in dB re 1 $\mu$Pa'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s">'Frequency in Hz'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="c1"># plt.savefig('longterm_spectrogram_2017.jpg',dpi=400 )
</span></code></pre></div></div><p><img src="/assets/images/aural/longterm_spectrogram_2017.jpg" alt="" /><div class="post-links"> <a class="link-to-post" href="/posts/evanger/"> <span class="link-to-post__prev">&#10535; &nbsp;Previous post</span> <span class="link-to-post__title">First ascents in 2020</span> </a></div></div></article></main><footer class="blog-footer content-wrapper"><p>&copy; <span class="full-year"></span> Sebastian Menze</footer><script src="/assets/js/scripts.js"></script>
